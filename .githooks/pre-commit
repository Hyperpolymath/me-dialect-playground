#!/bin/bash
# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 hyperpolymath
#
# Pre-commit hook to enforce Hyperpolymath Language Policy
# Blocks: TypeScript, Python, Go, npm/package.json

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Checking Hyperpolymath Language Policy...${NC}"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

VIOLATIONS=0

# Check for banned file types
for file in $STAGED_FILES; do
    # TypeScript files (banned - use ReScript)
    if [[ "$file" =~ \.tsx?$ ]] && [[ ! "$file" =~ \.d\.ts$ ]]; then
        echo -e "${RED}BLOCKED: TypeScript file detected: $file${NC}"
        echo "  → Use ReScript (.res) instead of TypeScript"
        VIOLATIONS=$((VIOLATIONS + 1))
    fi

    # Python files (banned except for SaltStack)
    if [[ "$file" =~ \.py$ ]]; then
        # Allow only SaltStack-related Python
        if [[ ! "$file" =~ (salt|pillar|grain|state|sls) ]]; then
            echo -e "${RED}BLOCKED: Python file detected: $file${NC}"
            echo "  → Python is only allowed for SaltStack. Use ReScript/Rust instead."
            VIOLATIONS=$((VIOLATIONS + 1))
        fi
    fi

    # Go files (banned - use Rust)
    if [[ "$file" =~ \.go$ ]]; then
        echo -e "${RED}BLOCKED: Go file detected: $file${NC}"
        echo "  → Use Rust instead of Go"
        VIOLATIONS=$((VIOLATIONS + 1))
    fi

    # package.json (banned - use deno.json)
    if [[ "$file" == "package.json" ]] || [[ "$file" =~ /package\.json$ ]]; then
        echo -e "${RED}BLOCKED: package.json detected: $file${NC}"
        echo "  → Use deno.json instead of package.json"
        VIOLATIONS=$((VIOLATIONS + 1))
    fi

    # package-lock.json, yarn.lock, pnpm-lock.yaml (banned)
    if [[ "$file" =~ (package-lock\.json|yarn\.lock|pnpm-lock\.yaml)$ ]]; then
        echo -e "${RED}BLOCKED: npm/yarn/pnpm lockfile detected: $file${NC}"
        echo "  → Use Deno which handles dependencies automatically"
        VIOLATIONS=$((VIOLATIONS + 1))
    fi

    # node_modules (should be gitignored anyway)
    if [[ "$file" =~ ^node_modules/ ]]; then
        echo -e "${RED}BLOCKED: node_modules detected: $file${NC}"
        echo "  → node_modules should not be committed"
        VIOLATIONS=$((VIOLATIONS + 1))
    fi
done

if [ $VIOLATIONS -gt 0 ]; then
    echo ""
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}  COMMIT BLOCKED: $VIOLATIONS language policy violation(s)${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "Hyperpolymath Language Policy:"
    echo "  - TypeScript → ReScript"
    echo "  - npm/Node.js → Deno"
    echo "  - Python (general) → ReScript/Rust"
    echo "  - Go → Rust"
    echo ""
    echo "See META.scm for complete language policy."
    exit 1
fi

echo -e "${GREEN}✓ Language policy check passed${NC}"
